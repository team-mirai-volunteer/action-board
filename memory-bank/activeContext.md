# Active Context - Action Board

## 現在の作業の焦点

### 主要な作業領域
現在のコードベースは **ミッション達成システム** のコア機能が実装済みの状態。主な完成済み機能：

1. **ユーザー認証システム** - 完全に動作中
2. **ミッション表示・詳細** - 基本機能完成
3. **成果物提出システム** - 6つのタイプ（LINK, TEXT, IMAGE, IMAGE_WITH_GEOLOCATION, NONE, REFERRAL）完全対応
4. **RLSセキュリティ** - データベースレベルで確実に動作
5. **画像アップロード・最適化** - Supabase Storage統合完了
6. **ユーザーレベルシステム** - XP付与・レベル計算機能完全実装済み
7. **バッチ処理システム** - XP未付与達成の修復処理実装済み
8. **紹介システム** - QRコード・紹介URL生成機能完全実装済み

### 最近の主要な変更（2025年6月11日現在）

#### 1. 紹介システム（REFERRAL）の完全実装（NEW）
- **ミッション**: REFERRAL タイプのミッション実装済み
- **QRコード生成**: `QRCodeDisplay` コンポーネントによる自動QRコード表示
- **紹介URL管理**: ユーザー固有の8桁紹介コード生成・管理
- **サインアップ連携**: 紹介URL経由でのユーザー登録時の自動ミッション達成処理
- **データベース**: `user_referral` テーブルによる紹介コード管理
- **UI**: 紹介URLコピー機能、QRコード表示機能

#### 2. バッチ処理システムの実装
- **ファイル**: `/app/api/batch/backfill-missing-xp/route.ts`
- **目的**: XPが付与されていないミッション達成にポイントを後付けで付与
- **機能**: 
  - POST: バッチ処理実行（管理者認証付き）
  - GET: 処理対象統計の確認
  - 自動的な未処理達成検出とXP付与
- **ドキュメント**: `/docs/batch-processing.md` - 完全な運用ガイド

#### 3. TEXT成果物タイプの追加
- **ファイル**: `supabase/migrations/20250531100854_add_text_artifact_type.sql`
- **影響**: `mission_artifacts`テーブルに`text_content`カラム追加
- **バリデーション**: CHECK制約の更新

#### 4. 位置情報機能の強化
- **テーブル**: `mission_artifact_geolocations`
- **機能**: 緯度・経度・精度・高度の記録
- **連携**: 画像成果物との関連付け

#### 5. 達成取り消し機能
- **Server Action**: `cancelSubmissionAction`
- **カスケード削除**: 成果物・位置情報の自動削除
- **権限管理**: 本人のみ削除可能

#### 6. コンポーネント分離の進化
- **分離設計**: `MissionWithSubmissionHistory` の高度な関心分離
- **型安全性**: Discriminated Union パターンの完全活用
- **再利用性**: 汎用コンポーネントの充実

#### 7. クイズ機能の完全実装完了（2025年6月15日）
- **データベース設計**: 4つのテーブル作成完了
  - `quiz_categories`: カテゴリ管理
  - `quiz_questions`: 問題データ（52問投入完了）
  - `quiz_sessions`: セッション管理
  - `quiz_answers`: 回答記録
- **型定義**: Supabase自動生成型（`lib/types/supabase.ts`）を直接使用 - リファクタリング完了
- **サービス層**: `lib/services/quiz.ts` - 関数ベースで実装完了、supabase型使用に変更済み
- **Server Actions**: `app/missions/[id]/actions.ts`に実装完了
  - `startQuizAction`: カテゴリごとに固定3問をランダム順で出題
  - `submitQuizAnswerAction`: 回答記録と正誤判定
  - `completeQuizAction`: 全問正解でのみクリア、2回までのクリア上限制御
- **UI/UX**: `components/mission/QuizComponent.tsx`完全実装
  - 難易度表示（初級/中級ラベル + 星表示）
  - ラジオボタンによる選択肢表示
  - 即座の正誤表示と解説
  - 最終結果とミッション達成処理
  - エラーハンドリングとローディング状態
- **バリデーション**: `lib/validation/quiz.ts` - Zodスキーマ完備
- **ドキュメント**: 実装ガイドとアクションアイテム作成済み
- **RLSセキュリティ**: ユーザーは自分のデータのみアクセス可能
- **カテゴリ**: 政策・マニフェスト、チームみらい、公職選挙法の3つ
- **マイグレーション**: データベースリセット・型定義再生成完了
- **リファクタリング**: `lib/types/quiz.ts`削除完了、サービス層でsupabase型を直接使用
- **仕様実装完了**:
  - ✅ カテゴリごとに固定の3問出題
  - ✅ 出題順はランダム
  - ✅ 全問正解でクリア
  - ✅ クリア上限2回まで
  - ✅ 合格まで何度でも挑戦可
  - ✅ 難易度ラベル（初級/中級）表示

## 次のステップ

### 短期タスク（1-2週間）

#### 1. 紹介システムの運用最適化
- **分析機能**: 紹介コード使用統計の実装
- **管理機能**: 無効な紹介コードの検出・管理
- **UI改善**: 紹介成功時の通知機能

#### 2. バッチ処理システムの本格運用
- **環境変数設定**: 本番環境での`BATCH_ADMIN_KEY`設定
- **運用テスト**: 開発環境でのバッチ処理動作確認
- **モニタリング**: バッチ処理実行時のログ監視体制構築

#### 3. ユーザビリティ向上
- **エラーメッセージの改善**: より具体的で実行可能な指示
- **ローディング状態の改善**: 提出中の明確な表示
- **フォームバリデーションの強化**: リアルタイム検証

#### 4. テスト強化
- **E2Eテストの拡充**: 紹介システムのテスト追加
- **E2Eテストの拡充**: 成果物提出フローのテスト追加
- **RLSテストの追加**: 新しいポリシーのテスト
- **エラーハンドリングテスト**: 境界条件のテスト
- **バッチ処理テスト**: バッチ処理APIのテストケース追加

#### 7. パフォーマンス最適化
- **画像読み込みの最適化**: Progressive loading実装
- **データフェッチの最適化**: 不要なクエリの削除
- **バンドルサイズの最適化**: 未使用コードの削除

### 中期タスク（1-2ヶ月）

#### 1. 機能拡張
- **ミッション検索・フィルタ**: 難易度・タイプ別絞り込み
- **通知システム**: 新しいミッション・達成のお知らせ
- **統計ダッシュボード**: 個人・コミュニティの活動統計

#### 2. ソーシャル機能
- **コメント機能**: 成果物への簡単なフィードバック
- **いいね機能**: 他のユーザーの成果物への評価
- **フォロー機能**: 興味のあるユーザーの活動追跡

#### 3. 管理機能
- **ミッション管理画面**: 管理者によるミッションCRUD
- **成果物モデレーション**: 不適切な成果物の管理
- **ユーザー管理**: 基本的な管理機能

## アクティブな決定事項と考慮事項

### 1. 技術的決定事項

#### Discriminated Union パターンの採用
```typescript
const achieveMissionFormSchema = z.discriminatedUnion("requiredArtifactType", [
  linkArtifactSchema,
  textArtifactSchema,
  imageArtifactSchema,
  imageWithGeolocationArtifactSchema,
  noneArtifactSchema,
]);
```
**判断理由**: 成果物タイプごとの異なる要件への型安全な対応

#### Server Components優先の設計
**現状**: 大部分がServer Components
**例外**: フォーム操作、状態管理が必要な部分のみClient Components
**メリット**: 初期ロード高速化、SEO最適化

#### CHECK制約による整合性保証
```sql
CONSTRAINT ensure_artifact_data CHECK (
    (artifact_type = 'LINK' AND link_url IS NOT NULL AND ...) OR
    (artifact_type = 'TEXT' AND text_content IS NOT NULL AND ...) OR
    ...
);
```
**判断理由**: アプリケーションバグによるデータ不整合の防止

### 2. UX設計の決定事項

#### 成果物提出の段階的UX
1. **タイプ選択**: ミッション作成時に固定
2. **フォーム表示**: タイプに応じた動的フォーム
3. **バリデーション**: 即座のフィードバック
4. **提出**: 明確な成功・失敗の表示

#### 達成状況の可視化
- **個人進捗**: 達成回数 / 最大回数
- **コミュニティ進捗**: 総達成数の表示
- **状態表示**: 達成済み・進行中・未開始の明確な区別

### 3. 未解決の技術的課題

#### 1. 画像処理の最適化
**現状**: 240x240pxの固定リサイズ
**検討中**: 複数サイズの自動生成、WebP形式対応

#### 2. リアルタイム更新
**現状**: ページリロードによる更新
**検討中**: Supabaseリアルタイム機能の活用

#### 3. オフライン対応
**現状**: オンライン環境必須
**検討中**: PWA化、ローカルストレージ活用

### 4. セキュリティ考慮事項

#### ファイルアップロードセキュリティ
**現状**: MIME Type制限、サイズ制限
**検討中**: ウイルススキャン、より詳細な検証

#### 個人情報保護
**現状**: RLSによる基本的な保護
**検討中**: GDPR準拠、データエクスポート機能

## 現在の技術的負債

### 1. コード構造
- **重複コード**: 成果物取得ロジックの重複（`_lib/data.ts` と `MissionWithSubmissionHistory.tsx`）
- **型定義の分散**: `_lib/types.ts` と `_components/types.ts` の重複

### 2. テストカバレッジ
- **E2Eテスト**: 基本フローのみ、エラーケース不足
- **単体テスト**: ユーティリティ関数のテスト不足

### 3. エラーハンドリング
- **一貫性**: エラーメッセージの統一不足
- **詳細度**: デバッグ情報とユーザー向け情報の分離不足

## 監視すべき指標

### 1. 技術指標
- **ページロード時間**: 3秒以内維持
- **エラー率**: 2%以下維持  
- **ビルド時間**: 2分以内

### 2. ユーザー指標
- **ミッション完了率**: 80%以上目標
- **フォーム離脱率**: 30%以下目標
- **エラー遭遇率**: 10%以下目標

### 3. 事業指標
- **DAU**: 日次アクティブユーザー
- **成果物品質**: 取り消し率5%以下
- **地域分散**: 複数都道府県からの参加

---

**最終更新**: 2025-06-11  
**更新者**: GitHub Copilot  
**次回レビュー予定**: 2025-06-18
