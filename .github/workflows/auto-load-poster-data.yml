name: Auto Load Poster Data from Google Drive

on:
  schedule:
    # 3å›/æ—¥å®Ÿè¡Œ: 6:00, 14:00, 22:00 UTC (æ—¥æœ¬æ™‚é–“ 15:00, 23:00, 7:00)
    - cron: '0 6,14,22 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  auto-load-poster-data:
    name: Google Driveã‹ã‚‰ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’CSVè‡ªå‹•èª­ã¿è¾¼ã¿
    timeout-minutes: 30
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # Google Drive Service Accountèªè¨¼
      - name: Setup Google Drive Service Account
        run: |
          echo "Setting up Google Drive service account authentication..."
          echo "${{ secrets.GOOGLE_DRIVE_SERVICE_ACCOUNT_KEY }}" | base64 -d > /tmp/service-account-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/service-account-key.json" >> $GITHUB_ENV

      # Google Drive ã‚’ãƒã‚¦ãƒ³ãƒˆ (rcloneä½¿ç”¨)
      - name: Install and configure rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [gdrive]
          type = drive
          service_account_file = /tmp/service-account-key.json
          team_drive = 
          EOF

      - name: Mount Google Drive
        run: |
          mkdir -p ~/Google\ Drive/Shared\ drives
          rclone mount gdrive: ~/Google\ Drive/Shared\ drives --daemon --allow-other --vfs-cache-mode writes
          sleep 5
          echo "Google Drive mounted successfully"

      # Supabaseç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒç”¨ï¼‰
      - name: Set Supabase environment variables
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm ci

      # ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•èª­ã¿è¾¼ã¿å®Ÿè¡Œ
      - name: Run auto-load poster data
        run: |
          echo "ğŸš€ Starting automated poster data loading from Google Drive..."
          npm run poster:auto-load
          echo "âœ… Poster data loading completed!"

      # çµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      - name: Upload processing logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: poster-data-logs-${{ github.run_number }}
          path: |
            poster_data/choice.md
            poster_data/processed-files.json
          retention-days: 30

      # Google Driveã‚’ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆ
      - name: Cleanup Google Drive mount
        if: always()
        run: |
          fusermount -u ~/Google\ Drive/Shared\ drives || true
          rm -f /tmp/service-account-key.json
