# 開発ワークフロー

## ブランチ戦略
- `main` - 本番準備完了コード
- `develop` - 機能統合ブランチ (PRのデフォルトブランチ)
- `feat/xxx` - 機能ブランチ (`develop`から分岐、`develop`にマージ)

## コード品質ツール

### Biome
- インデント: スペース2つ
- クォート: ダブルクォート
- import文の自動整理
- `pnpm run biome:check:write` で自動修正

### Lefthook
- pre-commitフックでコミット時に自動フォーマット

### TypeScript
- strictモード有効
- `@/*`パスエイリアス設定済み
- `pnpm run typecheck` で型チェック

## テスト戦略

### ユニットテスト (Jest)
- カバレッジ目標: 80%以上
- テストファイル: `*.test.ts(x)`
- モック: `tests/__mocks__/`
- 実行: `pnpm run test:unit`

### RLSテスト
- 各テーブルのCRUD権限をテスト
- テストユーザー作成・削除を自動化
- 実行: `pnpm run test:supabase`

### E2Eテスト (Playwright)
- 主要ユーザーフローをカバー
- デスクトップ・モバイルデバイス対応
- リトライ設定: 2回
- トレース: 失敗時のみ
- 実行: `pnpm run test:e2e`

## マイグレーション追加手順
1. `npx supabase migration new {名前}` - 新規マイグレーションファイル作成
2. SQLを記述
3. `pnpm run db:migrate` - ローカルに適用 + 型を再生成

## 重要な開発ノート
- **データベーススキーマ変更後は必ず `pnpm run types` を実行**
- **新規ミッション登録時は `mission_category_link` への登録が必須**
- **RLSポリシーは必ずテストを書く**
- **環境変数の追加時は `.env.example` も更新**
- **CI/CDではCloud Buildでミッションデータが自動同期される**

## 環境設定

必須環境変数 (`.env.example`を参照):

### Supabase
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

### 認証
- `LINE_CLIENT_SECRET`
- `NEXT_PUBLIC_LINE_CLIENT_ID`

### 監視・分析
- `NEXT_PUBLIC_SENTRY_DSN`
- `NEXT_PUBLIC_GA_ID`

### バッチ処理
- `BATCH_ADMIN_KEY`

### 外部連携
- `HUBSPOT_API_KEY` (オプション)
- `MAILGUN_API_KEY` (メール送信用)
- `YOUTUBE_API_KEY` (YouTube動画同期用)
