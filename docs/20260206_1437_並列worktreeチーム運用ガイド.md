# 並列worktreeチーム運用ガイド

複数の独立したPRを、git worktree + Claude Codeエージェントチームで並列に作成するワークフロー。

## 概要

```
ユーザー
  │  タスク一覧を指示（or /parallel-pr で自動化）
  ▼
リーダー（Claude Code メインセッション）
  │  worktree作成 → チーム組成 → エージェント起動 → CI確認 → クリーンアップ
  ▼
┌──────────┬──────────┬──────────┐
│ agent-a  │ agent-b  │ agent-c  │  ...
│ worktree │ worktree │ worktree │
│ PR #1,#2 │ PR #3    │ PR #4,#5 │
└──────────┴──────────┴──────────┘
```

## 構成要素

| 要素 | ファイル | 役割 |
|------|---------|------|
| スキル | `.claude/skills/parallel-pr/SKILL.md` | リーダーの段取り全体を自動化（`/parallel-pr`で呼び出し） |
| エージェント | `.claude/agents/worktree-worker.md` | ワーカーの行動指針（ブランチ作成→実装→PR作成） |
| ナレッジ | MEMORY内 `parallel-worktree-pattern.md` | 過去の実績・注意事項の蓄積 |

## ワークフロー詳細

### Step 1: タスク整理

独立したPR一覧を設計する。各PRは他のPRに依存しないこと。

```
| # | ブランチ名     | 作業内容              | 対象ファイル         |
|---|---------------|----------------------|---------------------|
| 1 | feat/xxx      | ○○機能の実装          | src/features/xxx/   |
| 2 | test/yyy      | ○○のユニットテスト追加   | src/lib/yyy.test.ts |
| 3 | fix/zzz       | ○○のバグ修正          | src/components/zzz/ |
```

エージェント数の目安:
- **2-3 PR**: 2エージェント
- **4-6 PR**: 3-4エージェント
- **7-9 PR**: 4-5エージェント（上限）

1エージェントに1-2 PRを割り当てる。

### Step 2: worktree準備

```bash
# エージェントごとにworktreeを作成
git worktree add ../action-board-{team}-{x} -b {team}-{x}-base
mkdir -p ../action-board-{team}-{x}/.claude
cp .claude/settings.local.json ../action-board-{team}-{x}/.claude/

# 依存インストール（バックグラウンドで並列実行）
cd ../action-board-{team}-{x} && pnpm install --frozen-lockfile
```

- `{team}`: チーム名の略称（例: `test4`, `refactor2`）
- `{x}`: エージェント識別子（`a`, `b`, `c`, `d`）
- `settings.local.json` のコピーは必須（権限設定のため）

### Step 3: チーム組成

```
TeamCreate(team_name: "{目的}-{番号}")

TaskCreate × N  # 各エージェントの担当タスク
TaskUpdate      # owner設定 + in_progress
```

### Step 4: エージェント起動

```
Task(
  subagent_type: "general-purpose",
  team_name: "{チーム名}",
  name: "agent-{x}",
  mode: "bypassPermissions",
  run_in_background: true,
  prompt: "..."
)
```

プロンプトに含めるべき情報:
- worktreeの**絶対パス**
- 担当PR一覧（ブランチ名、対象ファイル、作業内容）
- 作業手順（ブランチ作成→実装→テスト→biome→コミット→プッシュ→PR作成）
- コミットメッセージに `Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>` を含める指示

### Step 5: 完了待ち＆CI確認

エージェントからの完了報告メッセージを待つ。全員完了後にCIを一括確認:

```bash
for pr in {PR番号リスト}; do
  echo "=== PR #$pr ==="
  gh pr checks $pr
done
```

### Step 6: CI失敗時の対応

| 失敗パターン | 対応 |
|-------------|------|
| flaky RLSテスト（upstream server error） | `gh run rerun <run-id> --failed` |
| TypeScript型エラー | worktreeで直接修正してpush |
| Biomeフォーマットエラー | worktreeで `pnpm run biome:check:write` して再push |

### Step 7: クリーンアップ

```bash
# 全エージェントにシャットダウン要求
SendMessage(type: "shutdown_request", recipient: "agent-{x}")

# 全員のシャットダウン完了を待ってから:

# worktree削除
git worktree remove ../action-board-{team}-{x}
git branch -D {team}-{x}-base

# チーム削除
TeamDelete
```

## 実績

| フェーズ | 内容 | エージェント数 | PR数 | 所要時間 |
|---------|------|--------------|------|---------|
| Phase 1 | 純粋関数ユニットテスト | 5 | 9 | 約5分 |
| Phase 2-3 | 重複コード統合リファクタリング | 3 | 3 | 約4分 |
| Phase 4 | 残り未テスト関数テスト | 4 | 7 | 約3分 |

## 注意事項

### エージェント数の制限
- **4-5エージェントが実用的上限**
- APIレート制限にかかりやすい
- CodeRabbitのレビューもレート制限にかかる（9PR同時は厳しい）

### CIのflaky問題
- `tests/supabase/rls/missions.test.ts` は「An invalid response was received from the upstream server」で時々失敗する
- 本当のエラーかflakyかはログを確認してから判断する
- flakyなら `gh run rerun <id> --failed` で再実行

### worktreeの注意
- パスは `../action-board-{name}` 形式（CLAUDE.mdのルール）
- ブランチ名は一意にすること（`{team}-{x}-base` パターン推奨）
- `pnpm install` は並列実行しても安全（lockfileが同じため）
- 作業完了後は必ずworktreeを削除する（放置するとディスクを圧迫）
