# プロジェクト概要

## 主要ディレクトリ構造

### `/src/app` - Next.js App Router
- `(auth-pages)/` - 認証ルート (sign-in, sign-up, forgot-password)
  - Two-Step Signup フロー実装
  - Email/Password認証とLINE Login統合
- `(protected)/` - 認証が必要な保護されたルート
  - `settings/profile/` - プロフィール設定、アカウント削除
- `missions/[id]/` - ミッション詳細ページ
  - 成果物提出フォーム
  - クイズシステム統合
  - ソーシャル共有機能
- `users/[id]/` - ユーザープロフィールページ
- `ranking/` - ランキングページ (総合、ミッション別、都道府県別)
- `seasons/[slug]/` - シーズン別ランキング
- `map/` - マップ機能
  - `poster/` - ポスター掲示板マップ
  - `posting/` - ポスティングマップ
- `api/` - API Routes
  - `auth/callback/line/` - LINE Login コールバック
  - `batch/` - バッチ処理エンドポイント
  - `missions/[id]/og/` - OGP画像生成

### `/src/components` - 再利用可能なUIコンポーネント
- `ui/` - shadcn/uiベースコンポーネントのみ（純粋なUIプリミティブ）
- `common/` - アプリケーション横断で使用される共通コンポーネント
- `footer/` - フッター専用コンポーネント群
- `top/` - トップページ専用コンポーネント

### `/src/lib` - 共有ライブラリ
- `supabase/` - Supabaseクライアント設定
- `types/` - TypeScript型定義
- `validation/` - Zodバリデーションスキーマ
- `services/` - 外部サービス統合・ビジネスロジック（hubspot.ts, mail.ts, avatar.ts, seasons.ts）
- `utils/` - 汎用ユーティリティ関数（date-formatters.ts, metadata.ts, date-utils.ts等）
- `constants/` - アプリケーション定数

### `/src/features` - 機能ベースのディレクトリ構造
各機能は独立したディレクトリとして整理され、以下の構造を持ちます：
- `components/` - 機能固有のコンポーネント
- `services/` - 機能固有のビジネスロジック・データアクセス
- `types/` - 機能固有の型定義
- `actions/` - Server Actions（必要に応じて）
- `hooks/` - カスタムフック（必要に応じて）
- `utils/` - 機能固有のユーティリティ（必要に応じて）

主要な機能モジュール：
- `auth/` - 認証関連
- `missions/` - ミッション機能
- `mission-detail/` - ミッション詳細機能
- `ranking/` - ランキング機能
- `user-profile/` - ユーザープロフィール
- `user-settings/` - ユーザー設定
- `user-activity/` - ユーザー活動
- `metrics/` - メトリクス表示
- `map-poster/` - ポスターマップ
- `map-posting/` - 投稿マップ
- その他多数

### `/tests` - テストインフラストラクチャ
- `e2e/` - Playwright E2Eテスト
  - 認証フロー、ミッション完了、ランキング遷移など
- `rls/` - Supabase RLSポリシーテスト
  - 各テーブルのCRUD権限を網羅的にテスト
- `unit/` - ユニットテスト
  - ポスターボード最適化、進捗計算など
- `validation/` - バリデーションスキーマのテスト

### `/supabase` - Supabase設定
- `migrations/` - データベースマイグレーション
- `seed.sql` - 開発用シードデータ
- `config.toml` - Supabase設定

### `/mission_data` - ミッションデータ管理
- `missions.yaml` - ミッション定義
- `categories.yaml` - カテゴリー定義
- `category_links.yaml` - カテゴリーとミッションの紐付け
- `quiz_questions.yaml` - クイズ問題定義
- `src/sync.ts` - データベース同期スクリプト

### `/packages` - pnpmワークスペースパッケージ
- `youtube_data/` - YouTube Data API連携パッケージ
  - `src/sync.ts` - YouTube動画同期スクリプト
  - `src/youtube-client.ts` - YouTube APIクライアント
  - `src/types.ts` - 型定義

## データベーススキーマとセキュリティ

### 主要テーブル
- **ユーザー関連**
  - `private_users` - 非公開ユーザー情報
  - `public_user_profiles` - 公開プロフィール
  - `user_levels` - レベルとXP (シーズン対応)
  - `xp_transactions` - XP取得履歴
- **ミッション関連**
  - `missions` - ミッション定義
  - `achievements` - ミッション達成記録
  - `mission_artifacts` - 提出成果物
  - `mission_category_link` - カテゴリー紐付け
- **クイズシステム**
  - `quiz_questions` - クイズ問題
  - `quiz_categories` - クイズカテゴリー
- **ポスター/投稿関連**
  - `poster_boards` - ポスター掲示板情報
  - `poster_activities` - ポスター活動記録
  - `posting_activities` - 機関誌投稿活動
- **YouTube関連**
  - `youtube_videos` - YouTube動画マスターデータ
  - `youtube_video_stats` - 動画統計情報の日次スナップショット
- **その他**
  - `user_badges` - 獲得バッジ
  - `seasons` - シーズン定義

### RLSポリシー
- 全テーブルでRLS有効
- 認証ユーザーのみアクセス可能
- 自分のデータのみ更新可能
- `/tests/rls/`で網羅的にテスト

## 認証フロー

### Two-Step Signup
1. **フェーズ1**: 基本情報入力 (メール、パスワード、利用規約同意)
2. **フェーズ2**: プロフィール情報入力 (名前、都道府県など)

### LINE Login統合
- OAuth 2.0フロー実装
- `/api/auth/callback/line/`でコールバック処理
- 既存アカウントとの紐付け対応

## ミッションシステム

### 成果物タイプ
- `LINK` - URL提出
- `TEXT` - テキスト提出
- `IMAGE` - 画像アップロード
- `IMAGE_WITH_GEOLOCATION` - 位置情報付き画像
- `POSTER` - ポスター掲示活動
- `POSTING` - 機関誌配布活動
- `EMAIL` - メールアドレス提出
- `NONE` - 提出不要

### 特殊ミッションタイプ
- `QUIZ` - クイズ形式
- `LINK_ACCESS` - リンクアクセスで完了

## シーズンシステム
- 期間限定のランキングとXP集計
- `seasons`テーブルで管理
- シーズン別ランキング関数実装

## ユーザーレベルとXPシステム
- ミッション完了でXP獲得
- 自動レベルアップ通知
- シーズン対応のXP集計
- 紹介システムによるボーナスXP
