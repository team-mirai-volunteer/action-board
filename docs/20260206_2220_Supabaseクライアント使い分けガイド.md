# Supabaseクライアント使い分けガイド

## 概要

このプロジェクトには2種類のSupabaseクライアントがあり、用途に応じて正しく使い分ける必要があります。

| クライアント | 用途 | cookie/セッション | RLSバイパス |
|---|---|---|---|
| `createClient()` | 認証操作（セッション管理） | あり | なし |
| `createAdminClient()` | データベース操作（CRUD） | なし | あり |

また、用途別のヘルパー関数も提供されています：

| ヘルパー | 説明 |
|---|---|
| `getAuth()` | `createClient().auth` のショートカット。認証操作用 |
| `getStorage()` | `createClient().storage` のショートカット。ファイル操作用 |

## `createClient()` を使うべき場面

**ファイル**: `@/lib/supabase/client`

- `supabase.auth.getUser()` - 現在のログインユーザー取得
- `supabase.auth.exchangeCodeForSession()` - OAuthコールバック処理
- `supabase.auth.updateUser()` - ユーザー情報更新
- `supabase.storage.from("bucket")` - ファイルアップロード、Public URL取得
- その他すべての `supabase.auth.*` / `supabase.storage.*` 操作

**理由**: `createClient` は `@supabase/ssr` の `createServerClient` を使い、Next.jsのcookieと連携してセッション情報を読み書きします。

### ヘルパー関数の利用

```typescript
import { getAuth, getStorage } from "@/lib/supabase/client";

// 認証操作
const { data: { user } } = await getAuth().getUser();

// Storage操作
const { data } = getStorage().from("avatars").getPublicUrl(avatarPath);
```

## `createAdminClient()` を使うべき場面

**ファイル**: `@/lib/supabase/adminClient`

- `supabase.from("table").select()` - テーブルデータの読み取り
- `supabase.from("table").insert()` / `.update()` / `.delete()` - テーブルデータの書き込み
- その他すべての `supabase.from(...)` 操作

**理由**: RLSポリシーが削除されているため、`service_role` キーを持つ `createAdminClient` でないとデータにアクセスできません。

## 両方が必要な場合のパターン

認証とデータベース操作の両方が必要な場合は、2つのクライアントを併用します：

```typescript
import { getAuth } from "@/lib/supabase/client";
import { createAdminClient } from "@/lib/supabase/adminClient";

export async function someAction() {
  // 認証: cookie-aware clientでユーザー取得
  const { data: { user } } = await getAuth().getUser();
  if (!user) throw new Error("Not authenticated");

  // DB操作: admin clientでデータアクセス
  const supabaseAdmin = await createAdminClient();
  const { data } = await supabaseAdmin.from("table").select().eq("user_id", user.id);
}
```

## 禁止パターン

```typescript
// NG: admin clientで認証操作 → cookieが読めずセッション取得失敗
const supabase = await createAdminClient();
const { data: { user } } = await supabase.auth.getUser(); // 動かない

// NG: 通常clientでDB操作 → RLSで拒否される
const supabase = createClient();
const { data } = await supabase.from("table").select(); // RLSで空結果
```

## レイヤー構成（services / actions / loaders）

クライアントコンポーネント（`"use client"`）からサーバーサイドのDB操作を呼び出す場合、直接 `services/` をimportせず、`actions/` または `loaders/` を経由します。

| レイヤー | ディレクティブ | 用途 | 認証 |
|---|---|---|---|
| `services/` | `import "server-only"` | DB操作の内部実装 | なし（呼び出し元が保証） |
| `actions/` | `"use server"` | mutation操作のエントリポイント | セッションからユーザーID取得 |
| `loaders/` | `"use server"` | 読み取り操作のエントリポイント | 必要に応じてセッション取得 |

### なぜ必要か

- `services/` は `createAdminClient`（`SUPABASE_SERVICE_ROLE_KEY`）を使うため、クライアントサイドでは動作しない
- `"use server"` を付けた `actions/` / `loaders/` はNext.jsのServer Action機能で自動的にサーバーサイドで実行される
- `actions/` でセッションからユーザーIDを取得することで、クライアントからuserIdを渡す必要がなく認可的に安全

### 実装パターン

```typescript
// services/posting-shapes.ts (内部実装、server-only)
import "server-only";
import { createAdminClient } from "@/lib/supabase/adminClient";

export async function deleteShape(id: string, userId: string) {
  const supabase = await createAdminClient();
  await supabase.from("posting_shapes").delete().eq("id", id).eq("user_id", userId);
}

// actions/posting-shapes-actions.ts (エントリポイント)
"use server";
import { createClient } from "@/lib/supabase/client";
import { deleteShape as deleteShapeService } from "../services/posting-shapes";

export async function deleteShape(id: string) {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("認証が必要です");
  return deleteShapeService(id, user.id);
}

// loaders/posting-shapes-loaders.ts (エントリポイント)
"use server";
import { loadShapes as loadShapesService } from "../services/posting-shapes";

export async function loadShapes(eventId: string) {
  return loadShapesService(eventId);
}
```

### クライアントコンポーネントでの使用

```typescript
// components/posting-page.tsx
"use client";
import { deleteShape } from "../actions/posting-shapes-actions"; // mutation → actions
import { loadShapes } from "../loaders/posting-shapes-loaders"; // 読み取り → loaders
// NG: import { deleteShape } from "../services/posting-shapes"; // services直接importは禁止
```

## 判断フローチャート

1. `supabase.auth.*` を使う？ → `createClient()` または `getAuth()`
2. `supabase.storage.*` を使う？ → `createClient()` または `getStorage()`
3. `supabase.from(...)` を使う？ → `createAdminClient()`
4. 上記を複数組み合わせる？ → それぞれのクライアントを併用
5. クライアントコンポーネントからDB操作を呼ぶ？ → `actions/` または `loaders/` 経由
