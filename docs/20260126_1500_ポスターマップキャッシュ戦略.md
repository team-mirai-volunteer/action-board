# ãƒã‚¹ã‚¿ãƒ¼ãƒãƒƒãƒ—ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

## æ¦‚è¦

ãƒã‚¹ã‚¿ãƒ¼ãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿é€Ÿåº¦ã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’ç­–å®šã™ã‚‹ã€‚
æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯Cloud Runä¸Šã§å‹•ä½œã—ã¦ã„ã‚‹ãŸã‚ã€Vercelå›ºæœ‰ã®æ©Ÿèƒ½ï¼ˆEdge Configã€ISRç­‰ï¼‰ã¯ä½¿ç”¨ã§ããªã„ç‚¹ã‚’è€ƒæ…®ã™ã‚‹ã€‚

## ç¾çŠ¶åˆ†æ

### ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client        â”‚â”€â”€â”€â”€â–¶â”‚   Cloud Run     â”‚â”€â”€â”€â”€â–¶â”‚   Supabase      â”‚
â”‚   (Browser)     â”‚     â”‚   (Next.js)     â”‚     â”‚   (PostgreSQL)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                        ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—
                        (æ¯å›DBã‚¢ã‚¯ã‚»ã‚¹)
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

| å„ªå…ˆåº¦ | å•é¡Œ | å½±éŸ¿ |
|--------|------|------|
| é«˜ | `getPosterBoardSummaryByDistrict()` ãŒå…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§é›†è¨ˆ | åˆå›èª­ã¿è¾¼ã¿ãŒé…ã„ |
| é«˜ | ãƒšãƒ¼ã‚¸è¨ªå•ã”ã¨ã«åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰ | ä¸è¦ãªDBè² è· |
| é«˜ | åœ°åŒºãƒãƒƒãƒ—ã§5,000ä»¶ãšã¤ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å–å¾—ï¼ˆè¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ | å¤§é‡APIã‚³ãƒ¼ãƒ« |
| ä¸­ | Web Workerã®é–¾å€¤ãŒ10,000ä»¶ä»¥ä¸Šã§ã®ã¿ç™ºå‹• | UIãƒ•ãƒªãƒ¼ã‚º |
| ä¸­ | ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ç”ŸæˆãŒãƒ¡ãƒ¢åŒ–ã•ã‚Œã¦ã„ãªã„ | å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°è² è· |

### ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **æ¦‚è¦ãƒšãƒ¼ã‚¸ (`/map/poster`)**
   - `getPosterBoardSummaryByDistrict()` â†’ å…¨poster_boardså–å¾— â†’ JSå´ã§é›†è¨ˆ
   - `getPosterBoardTotals()` â†’ é¸ç®¡ãƒ‡ãƒ¼ã‚¿å–å¾—

2. **åœ°åŒºè©³ç´°ãƒšãƒ¼ã‚¸ (`/map/poster/[district]`)**
   - `getPosterBoardsMinimalByDistrict()` â†’ 5,000ä»¶ãšã¤ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
   - `getPosterBoardStatsByDistrictAction()` â†’ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—
   - `getUserEditedBoardIdsByDistrictAction()` â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†å±¥æ­´

## Cloud Runç’°å¢ƒã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

### åˆ¶ç´„äº‹é …

- **ä½¿ç”¨ä¸å¯**: Vercel Edge Config, ISR (Incremental Static Regeneration), Edge Middleware
- **ä½¿ç”¨å¯**: Next.js `unstable_cache`, HTTP Cache-Control, å¤–éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ“ã‚¹, Supabase RPC

### æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

Cloud Runç’°å¢ƒã§ã¯ä»¥ä¸‹ã®3å±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’æ¨å¥¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Layer 1       â”‚  ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (Cache-Control)
â”‚   Client Cache  â”‚  - é™çš„ãƒ‡ãƒ¼ã‚¿: 1æ™‚é–“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Layer 2       â”‚  ã‚µãƒ¼ãƒãƒ¼ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ (unstable_cache / LRU)
â”‚   Server Cache  â”‚  - çµ±è¨ˆãƒ‡ãƒ¼ã‚¿: 5-30åˆ†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Layer 3       â”‚  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ– (RPC, Materialized View)
â”‚   DB Layer      â”‚  - äº‹å‰é›†è¨ˆãƒ‡ãƒ¼ã‚¿
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

### Phase 1: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå³åŠ¹æ€§é«˜ï¼‰

#### 1.1 Next.js `unstable_cache` ã®å°å…¥

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/map-poster/services/poster-boards.ts`

```typescript
import { unstable_cache } from "next/cache";

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãçµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—
export const getCachedPosterBoardSummary = unstable_cache(
  async () => {
    // æ—¢å­˜ã® getPosterBoardSummaryByDistrict ãƒ­ã‚¸ãƒƒã‚¯
    return await getPosterBoardSummaryByDistrict();
  },
  ["poster-board-summary"],
  {
    revalidate: 300, // 5åˆ†
    tags: ["poster-summary"],
  }
);

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãé¸ç®¡ãƒ‡ãƒ¼ã‚¿å–å¾—
export const getCachedPosterBoardTotals = unstable_cache(
  async () => {
    return await getPosterBoardTotals();
  },
  ["poster-board-totals"],
  {
    revalidate: 3600, // 1æ™‚é–“ï¼ˆã»ã¼ä¸å¤‰ï¼‰
    tags: ["poster-totals"],
  }
);
```

**æ³¨æ„**: `unstable_cache`ã¯Cloud Runã§ã‚‚å‹•ä½œã™ã‚‹ãŒã€ã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã€‚

#### 1.2 ãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«ã® `revalidate` è¨­å®š

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/map/poster/page.tsx`

```typescript
// ISRã®ä»£æ›¿ã¨ã—ã¦é™çš„ç”Ÿæˆ + revalidate
export const revalidate = 300; // 5åˆ†ã”ã¨ã«å†ç”Ÿæˆ

// ã¾ãŸã¯ dynamic = 'force-static' ã§ãƒ“ãƒ«ãƒ‰æ™‚ã«é™çš„ç”Ÿæˆ
export const dynamic = "force-dynamic"; // Cloud Runã§ã¯å‹•çš„ã®ã¾ã¾
```

#### 1.3 API Route ã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/api/map/poster/summary/route.ts`

```typescript
import { NextResponse } from "next/server";
import { getPosterBoardSummaryByDistrict } from "@/features/map-poster/services/poster-boards";

export async function GET() {
  const data = await getPosterBoardSummaryByDistrict();

  return NextResponse.json(data, {
    headers: {
      "Cache-Control": "public, s-maxage=300, stale-while-revalidate=600",
    },
  });
}
```

**å·¥æ•°è¦‹ç©**: 1-2æ—¥

---

### Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ã®æœ€é©åŒ–

#### 2.1 é›†è¨ˆç”¨RPCé–¢æ•°ã®ä½œæˆ/æœ€é©åŒ–

**å¯¾è±¡**: Supabase Migration

ç¾åœ¨ `getPosterBoardSummaryByDistrict()` ã¯å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦JSå´ã§é›†è¨ˆã—ã¦ã„ã‚‹ã€‚
ã“ã‚Œã‚’DBå´ã§é›†è¨ˆã™ã‚‹RPCé–¢æ•°ã‚’ä½œæˆã™ã‚‹ã€‚

```sql
-- Migration: create_poster_summary_rpc.sql
CREATE OR REPLACE FUNCTION get_poster_board_summary_by_district()
RETURNS TABLE (
  district TEXT,
  total_count BIGINT,
  not_yet_count BIGINT,
  reserved_count BIGINT,
  done_count BIGINT,
  ng_prohibited_count BIGINT,
  ng_no_space_count BIGINT,
  ng_other_count BIGINT,
  other_count BIGINT
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    pb.district,
    COUNT(*)::BIGINT as total_count,
    COUNT(*) FILTER (WHERE pb.status = 'not_yet')::BIGINT,
    COUNT(*) FILTER (WHERE pb.status = 'reserved')::BIGINT,
    COUNT(*) FILTER (WHERE pb.status = 'done')::BIGINT,
    COUNT(*) FILTER (WHERE pb.status = 'ng_prohibited')::BIGINT,
    COUNT(*) FILTER (WHERE pb.status = 'ng_no_space')::BIGINT,
    COUNT(*) FILTER (WHERE pb.status = 'ng_other')::BIGINT,
    COUNT(*) FILTER (WHERE pb.status = 'other')::BIGINT
  FROM poster_boards pb
  WHERE pb.archived = false
  GROUP BY pb.district;
END;
$$ LANGUAGE plpgsql STABLE;
```

#### 2.2 Materialized Viewã®æ´»ç”¨

é »ç¹ã«æ›´æ–°ã•ã‚Œãªã„ãƒ‡ãƒ¼ã‚¿ã«ã¯Materialized Viewã‚’ä½¿ç”¨ï¼š

```sql
-- é›†è¨ˆçµæœã‚’Materialized Viewã¨ã—ã¦ä¿å­˜
CREATE MATERIALIZED VIEW poster_board_summary_mv AS
SELECT
  district,
  status,
  COUNT(*) as count
FROM poster_boards
WHERE archived = false
GROUP BY district, status;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE UNIQUE INDEX ON poster_board_summary_mv (district, status);

-- å®šæœŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆSupabase Edge Functionã¾ãŸã¯cronï¼‰
-- REFRESH MATERIALIZED VIEW CONCURRENTLY poster_board_summary_mv;
```

#### 2.3 å®šæœŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®è¨­å®š

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³A**: Supabase pg_cronï¼ˆæ¨å¥¨ï¼‰

```sql
-- 5åˆ†ã”ã¨ã«Materialized Viewã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
SELECT cron.schedule(
  'refresh-poster-summary',
  '*/5 * * * *',
  'REFRESH MATERIALIZED VIEW CONCURRENTLY poster_board_summary_mv'
);
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³B**: Cloud Scheduler + Cloud Function

```yaml
# cloud-scheduler-config.yaml
name: refresh-poster-summary
schedule: "*/5 * * * *"
httpTarget:
  uri: https://api.action-board.example/api/batch/refresh-poster-summary
  httpMethod: POST
  headers:
    Authorization: "Bearer ${BATCH_ADMIN_KEY}"
```

**å·¥æ•°è¦‹ç©**: 2-3æ—¥

---

### Phase 3: å¤–éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

Cloud Runç’°å¢ƒã§ã‚ˆã‚Šå …ç‰¢ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¿…è¦ãªå ´åˆï¼š

#### 3.1 Cloud Memorystore (Redis) ã®å°å…¥

```typescript
// lib/cache/redis.ts
import { createClient } from "redis";

const redisClient = createClient({
  url: process.env.REDIS_URL,
});

export async function getCachedData<T>(
  key: string,
  fetcher: () => Promise<T>,
  ttlSeconds: number = 300
): Promise<T> {
  const cached = await redisClient.get(key);
  if (cached) {
    return JSON.parse(cached);
  }

  const data = await fetcher();
  await redisClient.setEx(key, ttlSeconds, JSON.stringify(data));
  return data;
}
```

**ä½¿ç”¨ä¾‹**:

```typescript
// services/poster-boards.ts
export async function getPosterBoardSummaryWithCache() {
  return getCachedData(
    "poster:summary:all",
    () => getPosterBoardSummaryByDistrict(),
    300 // 5åˆ†
  );
}
```

**ã‚³ã‚¹ãƒˆ**: Cloud Memorystore Basic tier - ç´„$0.016/GB/hour

#### 3.2 Upstash Redisï¼ˆã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ä»£æ›¿ï¼‰

Cloud Memorystore ã‚ˆã‚Šå®‰ä¾¡ã§ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã®å½±éŸ¿ã‚’å—ã‘ã«ãã„ï¼š

```typescript
import { Redis } from "@upstash/redis";

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});
```

**ã‚³ã‚¹ãƒˆ**: ç„¡æ–™æ ã‚ã‚Šã€å¾“é‡èª²é‡‘ã§ä½ã‚³ã‚¹ãƒˆ

**å·¥æ•°è¦‹ç©**: 3-5æ—¥ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰å«ã‚€ï¼‰

---

### Phase 4: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰æœ€é©åŒ–

#### 4.1 SWR / React Query ã«ã‚ˆã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥

```typescript
// hooks/usePosterBoardSummary.ts
import useSWR from "swr";

export function usePosterBoardSummary() {
  return useSWR(
    "/api/map/poster/summary",
    fetcher,
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: false,
      dedupingInterval: 300000, // 5åˆ†
    }
  );
}
```

#### 4.2 ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨

```typescript
// API Routeã§ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
headers: {
  "Cache-Control": "public, max-age=300, stale-while-revalidate=600",
  "CDN-Cache-Control": "public, max-age=300",
  "Vercel-CDN-Cache-Control": "public, max-age=300", // Vercelã®å ´åˆ
}
```

#### 4.3 Service Worker ã«ã‚ˆã‚‹ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå°†æ¥æ¤œè¨ï¼‰

ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã¯æ¯”è¼ƒçš„é™çš„ãªãŸã‚ã€Service Workerã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ¤œè¨å¯èƒ½ã€‚

**å·¥æ•°è¦‹ç©**: 1-2æ—¥

---

## å®Ÿè£…å„ªå…ˆé †ä½

| å„ªå…ˆåº¦ | æ–½ç­– | åŠ¹æœ | å·¥æ•° | è¤‡é›‘åº¦ |
|--------|------|------|------|--------|
| ğŸ”´ é«˜ | Phase 2.1: é›†è¨ˆç”¨RPCé–¢æ•° | â˜…â˜…â˜…â˜…â˜… | 1æ—¥ | ä½ |
| ğŸ”´ é«˜ | Phase 1.1: `unstable_cache` å°å…¥ | â˜…â˜…â˜…â˜…â˜† | 1æ—¥ | ä½ |
| ğŸŸ¡ ä¸­ | Phase 2.2: Materialized View | â˜…â˜…â˜…â˜…â˜† | 1-2æ—¥ | ä¸­ |
| ğŸŸ¡ ä¸­ | Phase 1.3: API Route ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ˜ãƒƒãƒ€ãƒ¼ | â˜…â˜…â˜…â˜†â˜† | 0.5æ—¥ | ä½ |
| ğŸŸ¡ ä¸­ | Phase 4.1: SWRå°å…¥ | â˜…â˜…â˜…â˜†â˜† | 1æ—¥ | ä½ |
| ğŸŸ¢ ä½ | Phase 3: Rediså°å…¥ | â˜…â˜…â˜…â˜…â˜… | 3-5æ—¥ | é«˜ |

---

## æ¨å¥¨å®Ÿè£…é †åº

### Step 1ï¼ˆå³æ™‚å¯¾å¿œï¼‰- 1-2æ—¥

1. **RPCé–¢æ•°ã®ä½œæˆ** (`get_poster_board_summary_by_district`)
2. **`getPosterBoardSummaryByDistrict` ã®æ›¸ãæ›ãˆ**ï¼ˆRPCå‘¼ã³å‡ºã—ã«å¤‰æ›´ï¼‰

ã“ã‚Œã ã‘ã§ã€å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—â†’JSé›†è¨ˆ ã‹ã‚‰ DBé›†è¨ˆâ†’çµæœã®ã¿å–å¾— ã«å¤‰ã‚ã‚Šã€å¤§å¹…ãªæ”¹å–„ãŒè¦‹è¾¼ã‚ã‚‹ã€‚

### Step 2ï¼ˆçŸ­æœŸï¼‰- 2-3æ—¥

3. **`unstable_cache` ã®å°å…¥**ï¼ˆçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã«5åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
4. **API Route ã®ä½œæˆ**ï¼ˆCache-Controlãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãï¼‰
5. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§SWRå°å…¥**

### Step 3ï¼ˆä¸­æœŸï¼‰- 1é€±é–“

6. **Materialized Viewã®å°å…¥**
7. **pg_cronã«ã‚ˆã‚‹å®šæœŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥è¨­å®š**
8. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬ãƒ»ç›£è¦–ã®è¿½åŠ **

### Step 4ï¼ˆé•·æœŸãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

9. **Rediså°å…¥ã®æ¤œè¨**ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
10. **CDNå°å…¥ã®æ¤œè¨**ï¼ˆCloud CDNç­‰ï¼‰

---

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

| æŒ‡æ¨™ | ç¾çŠ¶ï¼ˆæ¨å®šï¼‰ | Phase 1å¾Œ | Phase 2å¾Œ |
|------|-------------|-----------|-----------|
| æ¦‚è¦ãƒšãƒ¼ã‚¸åˆå›èª­ã¿è¾¼ã¿ | 3-5ç§’ | 1-2ç§’ | 0.5-1ç§’ |
| åœ°åŒºãƒšãƒ¼ã‚¸åˆå›èª­ã¿è¾¼ã¿ | 5-10ç§’ | 3-5ç§’ | 2-3ç§’ |
| DBã‚¯ã‚¨ãƒªæ•°/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | 5-10 | 2-3 | 1-2 |
| ã‚µãƒ¼ãƒãƒ¼è² è· | é«˜ | ä¸­ | ä½ |

---

## æ¤œè¨¼æ–¹æ³•

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬

```bash
# Lighthouse CI
pnpm dlx lighthouse https://action-board.example/map/poster --output=json

# Web Vitals
# - LCP (Largest Contentful Paint)
# - TTFB (Time to First Byte)
# - FCP (First Contentful Paint)
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ã®ç›£è¦–

```typescript
// ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ã‚’è¨˜éŒ²
console.log(`[Cache] poster-summary: ${cacheHit ? 'HIT' : 'MISS'}`);
```

### æœ¬ç•ªç’°å¢ƒã§ã®æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

1. **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§æ¤œè¨¼**
2. **ä¸€éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹**
3. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèªå¾Œã€å…¨ä½“å±•é–‹**

---

## ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å¯¾ç­– |
|--------|------|
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸æ•´åˆï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼‰ | é©åˆ‡ãªTTLè¨­å®šã€æ‰‹å‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ©Ÿèƒ½ |
| Cloud Runã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¶ˆå¤± | `unstable_cache`ã®ã¿ã«ä¾å­˜ã—ãªã„ã€Materialized Viewä½µç”¨ |
| Materialized Viewãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥è² è· | CONCURRENTLY ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä½¿ç”¨ã€ä½è² è·æ™‚é–“å¸¯ã«å®Ÿè¡Œ |
| Rediséšœå®³æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚ã¯DBã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹è¨­è¨ˆ |

---

## å‚è€ƒè³‡æ–™

- [Next.js Caching Documentation](https://nextjs.org/docs/app/building-your-application/caching)
- [Supabase RPC Functions](https://supabase.com/docs/guides/database/functions)
- [PostgreSQL Materialized Views](https://www.postgresql.org/docs/current/rules-materializedviews.html)
- [Cloud Run Best Practices](https://cloud.google.com/run/docs/tips/general)
- [Upstash Redis for Serverless](https://upstash.com/docs/redis/overall/getstarted)

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [ ] ãƒãƒ¼ãƒ ã§ã®æ–¹é‡ãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] Phase 1ã®è©³ç´°è¨­è¨ˆ
- [ ] RPCé–¢æ•°ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
- [ ] é–‹ç™ºç’°å¢ƒã§ã®æ¤œè¨¼
