# 党員バッジ機能 要件定義と実装計画

## 1. 背景と目的
- チームみらい党員（スターター／レギュラー／プレミアム）をアプリ内で識別し、ユーザー名の隣にバッジを表示することでメンバーシップの価値を可視化する。
- 党員情報は Google スプレッドシートで管理されているため、これを日次で Supabase に同期し、アプリ全体で参照可能にする。
- ユーザーが任意でバッジの表示／非表示を切り替えられるようにし、プライバシーや UI への配慮を行う。

## 2. ステークホルダーとユーザー
- **党員ユーザー**: 自身のバッジ表示を確認・設定する。
- **一般ユーザー**: バッジで党員ステータスを把握。
- **運用担当者**: スプレッドシートの名簿管理と同期結果の確認。

## 3. 関連ファイル・サービス
- バッジ画像: `public/img/party-member-badge/starter.svg`, `public/img/party-member-badge/regular.svg`, `public/img/party-member-badge/premium.svg`
- Supabase データベース（新テーブル `party_memberships` 予定）
- Google Sheets API（サービスアカウント認証）
- 同期コマンド `npm run sync-party-memberships`（新規追加）
- アカウント編集ページ（`/src/app/(protected)/settings/profile` 配下想定）

## 4. 機能要件
### 4.1 バッジ表示
- ユーザー名の右隣に党員プランに応じたバッジを表示する。
- ユーザー名表示箇所は全ページで統一された「バッジ付きユーザー名」コンポーネントを利用し、既存表示箇所（プロフィール、投稿、コメント、ランキング等）に導入する。
- バッジの表示可否はユーザー設定に従う（デフォルト表示）。
- 非党員ユーザーにはバッジを表示しない。

### 4.2 バッジ種類
- プランは `starter` / `regular` / `premium` の 3 種類。ファイル名と紐付くよう定義する。
- 必要であればプラン名から表示ラベル（例: スタータープラン）を生成し、ツールチップやアクセシビリティ用途に利用。

### 4.3 同期処理
- Google スプレッドシートから email をキーとして党員情報を取得し、Supabase の `party_memberships` テーブルを更新する。
- スプレッドシートに存在しない email は党員外として扱い、該当ユーザーの党員レコードを削除または無効化する。
- 同期は Github Actions から日次実行（深夜）し、ローカルでも手動実行可能な npm スクリプトを提供する。

### 4.4 ユーザー設定
- アカウント編集ページに「党員バッジ表示」セクションを追加し、表示／非表示を選択できるトグル（デフォルト ON）を提供。
- 選択状態は `party_memberships.badge_visibility`（boolean, default true）に保存し、バッジコンポーネントに反映する。

## 5. 非機能要件
- **セキュリティ**: サービスアカウントの鍵を環境変数で安全に管理。スプレッドシート ID も環境変数化。
- **拡張性**: 新プラン追加に備え、バッジマッピングと UI 表示は柔軟に拡張できる構造にする。
- **可観測性**: 同期処理でエラー発生時はログ出力し、Github Actions で検知しやすくする。
- **パフォーマンス**: バッジ画像は既存の静的アセットを利用し、コンポーネントは遅延なく描画。

## 6. データ要件
- `party_memberships` テーブル（新規）  
  | カラム | 型 | 説明 |
  | --- | --- | --- |
  | `user_id` | UUID | `auth.users` と紐付くユーザー ID（ユニーク制約） |
  | `plan` | text | `starter` / `regular` / `premium` |
  | `badge_visibility` | boolean | バッジ表示フラグ。default true |
  | `synced_at` | timestamptz | 最終同期日時 |
  | `metadata` | jsonb | オプション情報（開始日など、必要に応じて保持） |
- スプレッドシート列: `Email`, `CurrentPlanType` を参照。同期時に email で `auth.users` を検索して `user_id` を同定し、メールアドレス自体は DB に保存しない。

## 7. 同期ジョブ設計
- Google Sheets API を利用し、指定スプレッドシートのデータを取得。
- 取得データを email でユーザーと突合し、`party_memberships` を upsert（DB には `user_id` を保存）。`CurrentPlanType` が `donation` の行は同期対象から除外する。
- メールアドレスが Supabase ユーザーに存在しない場合は警告ログを出しつつスキップ（要リトライ可否判断）。
- スプレッドシートから消えたメールは `party_memberships` から削除。
- スプレッドシートのソースは https://docs.google.com/spreadsheets/d/1hJu60lqdHFJVeddoP6uTp7g8lX30G8NTPB-qb0EdooA/ の `Raw` シートを使用する。
- CLI エントリーポイント: `npm run sync-party-memberships` → `ts-node` or `tsup` で `src/scripts/sync-party-memberships.ts`（仮）を実行。
- Github Actions ワークフローで日次実行。Secrets でサービスアカウント JSON とスプレッドシート ID を渡す。

## 8. UI/UX 要件
- バッジ付きユーザー名コンポーネントはユーザー名とバッジ画像を横並び表示。必要に応じてラベルを sr-only で提供。
- トグル UI は既存の設定ページのデザインガイドライン（radix + shadcn/ui）に合わせる。
- 設定変更後は成功メッセージのトーストまたは UI 更新でフィードバック。

## 9. 実装計画
### 9.1 データベース・型更新
1. Supabase マイグレーションで `party_memberships` テーブルを作成し、`user_id` のユニーク制約と外部キーを設定。`badge_visibility` に default true を付与。
2. `npm run types` を実行し、`lib/types/supabase.ts` を更新。

### 9.2 サービス・同期スクリプト
1. Google Sheets サービスアカウント認証ロジックを `src/lib/services/google-sheets.ts`（仮）に実装し、環境変数（`GOOGLE_SERVICE_ACCOUNT_JSON`, `GOOGLE_PARTY_MEMBER_SPREADSHEET_ID` など）を参照。
2. `src/scripts/sync-party-memberships.ts`（仮）を作成し、シート（`Raw`）から取得→Supabase へ upsert/delete を行う。
3. `package.json` に `sync-party-memberships` スクリプトを追加。
4. Github Actions ワークフロー（`/.github/workflows/sync-party-memberships.yml`）を新設し、日次実行設定。

### 9.3 フロントエンド
1. バッジ表示用コンポーネント（例: `src/components/common/party-member-badge`）を新設。ユーザー名とバッジ画像・アクセシビリティラベルを提供。
2. 現在ユーザー名を表示している箇所を調査し、新コンポーネントに置き換え。共通化が難しい箇所はラッパーを提供。
3. バッジ表示可否を `party_memberships.badge_visibility` から取得し、表示状態を制御。レコードがない場合は非党員扱いで非表示、フラグ未設定時は default true を適用。
4. アカウント設定ページにトグル UI を追加し、Server Action または API で `badge_visibility` を更新。

### 9.4 テスト・検証
1. 同期スクリプトの単体テストを Jest で追加（スプレッドシートのモックデータを使用）。
2. バッジ付きユーザー名コンポーネントのユニットテスト／storybook があれば表示確認。
3. 設定トグルの Server Action のテスト。必要に応じ E2E テストで表示切替を確認。
4. Github Actions ワークフローのドライラン（`workflow_dispatch`）で動作確認。

### 9.5 ドキュメント・運用対応
1. `.env.example` に新環境変数（サービスアカウント JSON、スプレッドシート ID）を追記。
2. 運用手順書（必要なら docs/ 配下）に日次同期とバッジ管理の説明を追加。
3. バッジプラン追加時の手順（画像追加・コード更新）を README または開発者向けドキュメントに記載。

## 10. リスクと課題
- スプレッドシート側のデータ品質（メールの誤入力、重複）による同期失敗。
- ユーザー名表示箇所の網羅性を欠くとバッジが出ないページが発生する可能性。
- サービスアカウント JSON を環境変数に格納する際のフォーマッティング（改行）問題への対応。

## 11. 今後の検討事項
- プランごとの特典説明や詳細ページへの導線追加。
- 同期結果を管理画面で閲覧できる仕組み。
- バッジ表示の国際化／テーマ対応。
