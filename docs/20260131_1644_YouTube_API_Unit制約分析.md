# YouTube API Unit制約分析

## 概要

YouTube Data API v3のクォータ制約と、現在の実装における消費量を整理する。

## YouTube API Unitコスト

| API | コスト/回 | 用途 |
|-----|----------|------|
| `search.list` | **100 units** | #チームみらい動画検索 |
| `videos.list` | 1 unit | 動画詳細・統計取得 |
| `commentThreads.list` | 1 unit | コメント取得 |
| `playlistItems.list` | 1 unit | いいね動画・アップロード動画取得 |

**1日のクォータ: 10,000 units**

---

## 前提条件

- 直近1ヶ月のチームみらい動画: **500件**
- YouTube連携ユーザー数: **100人**
- コメント取得時の平均ページ数: **1ページ/動画**（大半の動画は1ページで収まる）

---

## バッチ処理（毎日0時実行）

GitHub Actions: `.github/workflows/sync-youtube-videos-production.yml`

### 実行される処理

| スクリプト | 処理内容 |
|-----------|---------|
| `youtube:sync-videos` | #チームみらい動画を検索してDB同期 |
| `youtube:sync-likes` | 全連携ユーザーのいいねを同期 |
| `youtube:sync-comments` | 直近1ヶ月の動画のコメントをキャッシュ |

### Unit消費量（推定）

| 処理 | API | 呼び出し回数 | 想定units |
|------|-----|------------|-----------|
| 動画検索 | `search.list` | 1-2回（50件ずつ） | **100-200** |
| 動画詳細取得 | `videos.list` | 500動画/50 = 10回 | **10** |
| いいね取得 | `playlistItems.list` | 100人 × 2回 | **200** |
| コメント取得 | `commentThreads.list` | 500動画 × 1ページ | **500** |

**バッチ合計: 約1,000 units/日**

---

## ユーザー同期ボタン

ファイル: `src/features/youtube/components/youtube-sync-button.tsx`

### 実行される処理

| 処理 | レート制限 | 管理方法 |
|------|-----------|---------|
| チームみらい動画検索 | 2時間（全体共通） | `youtube_sync_status`テーブル |
| 自分のアップロード動画 | なし | - |
| いいね取得 | なし | - |
| コメント取得 | 2時間（動画ごと） | `youtube_videos.comments_synced_at` |

### Unit消費量（推定）

| 処理 | API | 最大units |
|------|-----|-----------|
| チームみらい動画検索 | `search.list` | 100（2時間に1回のみ） |
| 自分のアップロード動画 | `playlistItems.list` + `videos.list` | 2-4 |
| いいね取得 | `playlistItems.list` | 2 |
| コメント取得 | `commentThreads.list` | 500（500動画 × 1ページ） |

---

## 問題シナリオ

### シナリオ1: バッチ直後にユーザーが同期 ✅ OK

```
バッチ（0:00）: 1,000 units
+ ユーザー同期（1:00）: 約100 units（コメントは2時間制限でスキップ）
→ 合計: 約1,100 units
```

### シナリオ2: バッチから2時間後にユーザーが同期 ✅ OK

```
バッチ（0:00）: 1,000 units
+ ユーザー同期（2:00以降）: 500 units（コメント再取得）
→ 合計: 約1,500 units（クォータの15%）
```

### シナリオ3: 1日に複数回のコメント同期 ✅ OK（2時間制限で安全）

```
バッチ（0:00）: 1,000 units
+ ユーザー同期（2:00）: 500 units
+ ユーザー同期（4:00）: 500 units
+ ユーザー同期（6:00）: 500 units
... × 12回（2時間おき、最大）
→ 合計: 7,000 units（クォータの70%）
```

※ 動画ごとに2時間のレート制限があるため、同じ動画のコメントは2時間以内に再取得されない。
  実際には異なるユーザーが同期しても、すでに他ユーザーが同期済みの動画はスキップされる。

---

## 現在のレート制限まとめ

| 項目 | 制限 | 管理テーブル/カラム |
|------|------|-------------------|
| チームみらい動画検索 | 2時間（全体共通） | `youtube_sync_status.last_synced_at` |
| コメント取得（動画ごと） | 2時間 | `youtube_videos.comments_synced_at` |
| いいね取得 | なし | - |
| 自分のアップロード動画 | なし | - |

---

## 改善案（未実装）

### 案1: コメント取得のレート制限を延長

```
現在: 1時間
変更案: 6時間 または 12時間
```

**メリット**: 1日のAPI呼び出し回数を大幅に削減
**デメリット**: コメントの検出が遅れる可能性

### 案2: ユーザー同期ではコメントAPI呼び出しをスキップ

```
ユーザー同期時:
- キャッシュ（youtube_video_comments）からのみ検索
- YouTube APIへのコメント取得はバッチ処理のみ
```

**メリット**: ユーザー操作によるAPI消費を大幅削減
**デメリット**: バッチ実行までコメントが検出されない

### 案3: コメント取得対象の動画数を制限

```
現在: 直近1ヶ月（約500動画）
変更案: 直近1週間（約100動画）
```

**メリット**: コメント取得のAPI消費を1/5に削減
**デメリット**: 古い動画へのコメントが検出されない

### 案4: いいね取得にもレート制限を追加

```
ユーザーごとに1時間制限
管理: youtube_user_connections.likes_synced_at
```

**メリット**: ユーザー操作によるAPI消費を削減
**デメリット**: いいねの検出が遅れる可能性

---

## 関連ファイル

- バッチワークフロー: `.github/workflows/sync-youtube-videos-production.yml`
- 動画同期スクリプト: `scripts/sync-youtube-videos.ts`
- いいね同期スクリプト: `scripts/sync-youtube-likes.ts`
- コメント同期スクリプト: `scripts/sync-youtube-comments.ts`
- 同期ボタン: `src/features/youtube/components/youtube-sync-button.tsx`
- 同期ステータステーブル: `youtube_sync_status`（RLS有効、ユーザーアクセス不可）
