# ポスターマップのシーズン対応実装

## 概要

選挙ごとにポスター掲示板のステータスを管理できるようにするため、`elections`テーブルを追加し、URL構造を変更しました。

## 実装内容

### 1. データベース設計

#### 1.1 elections テーブル

選挙情報を管理する新しいテーブルを作成しました。

```sql
CREATE TABLE elections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  season_id UUID NOT NULL REFERENCES seasons(id) ON DELETE CASCADE,
  start_date TIMESTAMP WITH TIME ZONE NOT NULL,
  end_date TIMESTAMP WITH TIME ZONE NOT NULL,
  subject election_subject NOT NULL,
  lgcodes TEXT[] NOT NULL DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);
```

**フィールド説明:**
- `id`: 選挙の一意識別子
- `season_id`: シーズンテーブルへの外部キー
- `start_date`: 選挙期間の開始日時
- `end_date`: 選挙期間の終了日時
- `subject`: 選挙の種類（enum型）
  - "衆院選"
  - "参院選"
  - "都道府県首長選"
  - "市区町村首長選"
- `lgcodes`: 対象となる地方公共団体コードの配列
  - https://www.soumu.go.jp/denshijiti/code.html
  - https://ja.wikipedia.org/wiki/%E5%85%A8%E5%9B%BD%E5%9C%B0%E6%96%B9%E5%85%AC%E5%85%B1%E5%9B%A3%E4%BD%93%E3%82%B3%E3%83%BC%E3%83%89
  - 適当な英語名称がないので lgcode と呼ぶことにします https://fukuno.jig.jp/3356
  - 都道府県コードは2桁、市区町村は5桁を使用する。末尾1桁は入力ミスを防ぐためのチェックサムなのでDBには入れない
  - 参院選では選挙区の候補を出した都道府県のリストを持つ
  - 衆院選は一旦都道府県としたが、実際は小選挙区で、 lgcode よりさらに細かい分割で選挙区が指定される。 poster_boards の絞り込みは手作業になるかも？

**RLSポリシー:**
- SELECT: 全ユーザー（匿名含む）が読み取り可能
- INSERT/UPDATE/DELETE: 誰にも不可能

#### 1.2 poster_board_status_history テーブルの拡張

選挙ごとにポスターのステータスを管理するため、`election_id`カラムを追加しました。

```sql
ALTER TABLE poster_board_status_history 
ADD COLUMN election_id UUID REFERENCES elections(id) ON DELETE SET NULL;
```

#### 1.3 初期データ

2025年参院選のレコードを自動的に作成し、既存の`poster_board_status_history`レコードをこの選挙にリンクします。

```sql
-- 2025年参院選
INSERT INTO elections (season_id, start_date, end_date, subject, lgcodes)
VALUES (
  season1_id,
  '2025-07-03 00:00:00+09',  -- 選挙期間開始
  '2025-07-20 20:00:00+09',  -- 選挙期間終了（投票日20時）
  '参院選',
  '{01, 04, 11, 12, 13, 14, 20, 23, 27, 28, 38, 40}'  -- 北海道, 宮城県, 埼玉、千葉、東京, 神奈川, 長野, 愛知,大阪、兵庫、愛媛、福岡
);
```

### 2. TypeScript型定義

`src/lib/types/supabase.ts`に以下の型を追加: (`npm run types` で自動生成)

- `Database["public"]["Tables"]["elections"]`: electionsテーブルの型
- `Database["public"]["Enums"]["election_subject"]`: 選挙種類のenum型
- `poster_board_status_history`の`election_id`フィールド

### 3. サービス層

`src/features/elections/services/elections.ts`を作成し、以下の関数を実装:

- `getAllElections()`: 全選挙を取得（開始日降順）
- `getElectionById(electionId)`: 特定の選挙を取得
- `getCurrentElection()`: 現在進行中または最も最近の選挙を取得
- `getElectionsBySeasonId(seasonId)`: 特定シーズンの選挙一覧を取得

### 4. URL構造の変更

#### 旧URL構造
```
/map/poster                    # 都道府県選択
/map/poster/[prefecture]       # ポスターマップ
```

#### 新URL構造
```
/map/poster                                      # → /map/poster/elections へリダイレクト
/map/poster/elections                            # 選挙一覧
/map/poster/elections/[electionId]               # 選挙別の都道府県選択
/map/poster/elections/[electionId]/[prefecture]  # 選挙別のポスターマップ
/map/poster/[prefecture]                         # → 現在の選挙の都道府県ページへリダイレクト
```

### 5. 画面実装

#### 5.1 選挙一覧ページ (`/map/poster/elections/page.tsx`)

- 全選挙を一覧表示
- 各選挙カードをクリックすると都道府県選択ページへ遷移
- 選挙期間を表示

#### 5.2 選挙別都道府県選択ページ (`/map/poster/elections/[electionId]/page.tsx`)

- 選挙情報をヘッダーに表示
- 既存の都道府県選択UIを再利用

#### 5.3 選挙別ポスターマップページ (`/map/poster/elections/[electionId]/[prefecture]/page.tsx`)

- 選挙情報をヘッダーに表示
- 既存のポスターマップUIを再利用
- 選挙ごとのポスターステータスを表示

### 6. テスト

#### 6.1 RLSテスト (`tests/rls/elections.test.ts`)

以下のシナリオをテスト:
- 匿名ユーザーは選挙一覧を読み取れる
- 認証済みユーザーは選挙一覧を読み取れる
- 匿名ユーザーは選挙を作成できない
- 認証済みユーザーは選挙を作成できない
- 認証済みユーザーは選挙を更新できない
- 認証済みユーザーは選挙を削除できない

## マイグレーションファイル

`supabase/migrations/20260113223552_add_elections_table.sql`

このマイグレーションを実行すると:
1. `election_subject` enum型が作成される
2. `elections`テーブルが作成される
3. `poster_board_status_history`に`election_id`カラムが追加される
4. 2025年参院選のレコードが作成される
5. 既存の`poster_board_status_history`レコードが2025年参院選にリンクされる

## 導入手順

### 開発環境

1. マイグレーションを適用
```bash
npx supabase db reset
```

2. TypeScript型を再生成
```bash
npm run types
```

3. 開発サーバーを起動
```bash
npm run dev
```

### 本番環境

1. Supabaseダッシュボードでマイグレーションを適用

2. Cloud Buildで自動的にTypeScript型が再生成される

## 今後の拡張

### ポスターステータス履歴の選挙別フィルタリング

現在、`poster_board_status_history`に`election_id`を追加しましたが、UIではまだ選挙別のフィルタリングは実装していません。必要に応じて以下を追加できます:

1. ポスターマップで選挙別のステータス履歴を表示
2. 選挙が切り替わった時のステータスリセット機能
3. 過去の選挙のステータス履歴閲覧

## 関連ファイル

### 新規作成
- `supabase/migrations/20260113223552_add_elections_table.sql`
- `src/features/elections/services/elections.ts`
- `src/app/map/poster/elections/page.tsx`
- `src/app/map/poster/elections/[electionId]/page.tsx`
- `src/app/map/poster/elections/[electionId]/[prefecture]/page.tsx`
- `tests/rls/elections.test.ts`

### 変更
- `src/lib/types/supabase.ts` - elections型、election_subject enum、poster_board_status_historyにelection_id追加
- `src/app/map/poster/page.tsx` - 選挙一覧ページへリダイレクト
- `src/app/map/poster/[prefecture]/page.tsx` - 現在の選挙のポスターマップへリダイレクト
- `biome.json` - 設定の更新

## 注意事項

### Season との関係

- **Season**: 切れ目のない期間管理（例: 2025年夏シーズン）
- **Election**: 選挙期間別の管理（例: 2025年参院選）

1つのSeasonに複数のElectionが含まれる可能性があります。
Season は常に存在し、current_season が何かしら存在する設計ですが、Election は選挙期間外には存在しないこともあります。

### lgcode

地方公共団体コードは総務省の規格に準拠:
https://www.soumu.go.jp/denshijiti/code.html

- 全国規模の選挙: 空配列 `[]`
- 都道府県首長選: `['13']` (東京都の例)
- 市区町村首長選: `['13101']` (千代田区の例)

## 参考

- 背景情報: https://team-mirai.notion.site/260f6f56bae180a29afcdcc694f94e91
- シーズンシステム要件: `docs/season-system-requirements.md`
