# バッチ処理 - Action Board

## 概要

Action Boardプロジェクトには、データの整合性を保つためのバッチ処理機能が実装されています。現在利用可能なバッチ処理は以下の通りです。

## 1. ミッション達成XP付与バッチ処理

### 目的
ユーザーレベルシステム導入前に達成されたミッション、またはシステムエラーによりXPが付与されなかったミッション達成に対して、適切なXPを後付けで付与する処理です。

### エンドポイント
- **URL**: `/api/batch/backfill-missing-xp`
- **メソッド**: `POST` (実行), `GET` (状況確認)

### 機能詳細

#### 処理内容
1. **未処理達成の検出**: XPトランザクションが記録されていないミッション達成を検索
2. **XP計算**: ミッション難易度に基づく適切なXP計算
   - Easy (難易度1): 50 XP
   - Normal (難易度2): 100 XP  
   - Hard (難易度3): 200 XP
3. **XP付与**: 各達成に対してXPトランザクションを作成し、ユーザーレベルを更新
4. **レポート生成**: 処理結果の詳細レポートを生成

#### セキュリティ
- **管理者認証**: `BATCH_ADMIN_KEY` 環境変数による認証が必要
- **サービスロール**: RLS制限を回避するためのサービスロールクライアントを使用

### 使用方法

#### 1. 環境変数の設定
```bash
# .env.local に追加
BATCH_ADMIN_KEY=your-secure-admin-key-here
```

#### 2. 状況確認 (GET リクエスト)
```bash
curl -X GET http://localhost:3000/api/batch/backfill-missing-xp
```

**レスポンス例:**
```json
{
  "statistics": {
    "totalAchievements": 150,
    "totalXpTransactions": 120,
    "missingXpAchievements": 30,
    "completionRate": 80
  },
  "message": "30 件のミッション達成にXPが付与されていません"
}
```

#### 3. バッチ処理実行 (POST リクエスト)
```bash
curl -X POST http://localhost:3000/api/batch/backfill-missing-xp \
  -H "Content-Type: application/json" \
  -d '{"adminKey": "your-secure-admin-key-here"}'
```

**レスポンス例:**
```json
{
  "success": true,
  "message": "XP付与バッチ処理が完了しました",
  "summary": {
    "total": 30,
    "processed": 28,
    "skipped": 1,
    "errors": 1
  },
  "results": [
    {
      "achievementId": "xxx-xxx-xxx",
      "userId": "yyy-yyy-yyy",
      "missionTitle": "ゴミ拾いをしよう",
      "xpGranted": 50,
      "status": "success"
    }
  ]
}
```

### 実行上の注意点

#### 実行前の確認事項
1. **バックアップ**: 本番環境では事前にデータベースバックアップを取得
2. **メンテナンスモード**: 可能であればサービスをメンテナンスモードに設定
3. **統計確認**: GET リクエストで処理対象データの規模を確認

#### 実行中の考慮事項
- **パフォーマンス**: 大量のデータがある場合は時間がかかる可能性があります
- **レート制限**: 各処理間に100msの待機時間を設定済み
- **トランザクション**: 個別のXP付与は独立して処理されるため、一部失敗でも他は継続

#### 実行後の検証
1. **統計再確認**: GET リクエストで処理結果を確認
2. **ユーザーレベル**: 影響を受けたユーザーのレベル情報を確認
3. **ログ確認**: サーバーログでエラーや警告メッセージを確認

### トラブルシューティング

#### よくある問題と対処法

**1. 認証エラー**
```json
{"error": "認証に失敗しました"}
```
- 環境変数 `BATCH_ADMIN_KEY` が正しく設定されているか確認
- リクエストボディに正しい `adminKey` が含まれているか確認

**2. データベース接続エラー**
```json
{"error": "ミッション達成データの取得に失敗しました"}
```
- Supabaseサービスロール設定を確認
- データベース接続情報を確認

**3. 部分的な処理失敗**
- レスポンスの `results` 配列で個別のエラーを確認
- エラーが発生したアイテムは手動で確認・修正が必要な場合があります

**4. 重複実行**
- バッチ処理は冪等性を持つため、重複実行しても問題ありません
- 既にXPが付与済みの達成は自動的にスキップされます

### ログ出力

処理中は以下のログが出力されます：

```
=== XP付与バッチ処理を開始します ===
XP未付与の達成が 30 件見つかりました
処理中: 達成ID xxx-xxx-xxx, ユーザーID yyy-yyy-yyy, XP 50
✓ 達成ID xxx-xxx-xxx にXP 50 を付与しました
=== XP付与バッチ処理が完了しました ===
処理成功: 28 件
スキップ: 1 件  
エラー: 1 件
```

## 今後の拡張予定

### 計画中のバッチ処理
1. **ユーザーレベル再計算**: XP値からレベルを再計算
2. **不整合データ修復**: データベース間の不整合を検出・修復
3. **統計データ更新**: 各種統計情報の再計算
4. **アーカイブ処理**: 古いデータの自動アーカイブ

### 運用改善
- **スケジュール実行**: cron式での定期実行機能
- **進捗監視**: リアルタイム進捗表示
- **通知機能**: 処理完了時の管理者通知
- **rollback機能**: 処理のロールバック機能